<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLYY</title>
    <link rel="stylesheet" href="../static/css/style.css">
    <style>
        /* ì¶”í›„ì— JSë¡œ song íŒŒì¼ì— ë„£ì„ ìˆ˜ ìˆì„ê¹Œ? */
        .main__container {
            background-image: url('../static/images/song-detail-background.jpg');
            background-repeat: no-repeat;
            background-size: cover;
        }
    </style>
</head>
<body>
    <main class="main">
        <div class="main__container">
            <!-- ìœ íˆ¬ë¸Œ ë¹„ë””ì˜¤ -->
            <div class="song__youtube">
                <div id="youtube__area">
                    <div id="player"></div>
                </div>
            </div>
            <!-- ê³¡ ì¸ë±ìŠ¤  -->
            <div class="song__index align both">
                <div class="index badge tag">
                    <span id="currentSongIndex">1</span>
                    <span>&nbsp;/&nbsp;</span>
                    <span id="lastSongIndex"></span>
                </div>
                <button class="btn__arrow-left--white" id="preSong"></button>
                <button class="btn__arrow-right" id="nextSong"></button>
            </div>
            <!-- ê³¡ ìƒì„¸ -->
            <div class="song" id="songInfo">
                <!-- <div class="song__img"><img src="images/@album_img2.svg"></div>
                <div class="song__info">
                    <p class="h1">Attention</p>
                    <p class="fs16">ë‰´ì§„ìŠ¤</p>
                    <p class="fs16">NewJeans 1st EP 'New Jeans'</p>
                </div> -->
            </div>
            <!-- ê³¡ì—ëŒ€í•œ íë ˆì´í„° ì½”ë©˜íŠ¸ -->
            <div class="song-cmt hide" id="songCmt">
                <!-- <div class="pretendard">ë‰´ì­ìŠ¤ìœ™ì„ ì‹œë„í•˜ëŠ” ê·¸ë£¹ì´ë‚˜ ì•„í‹°ìŠ¤íŠ¸ëŠ” ë§ì•˜ì§€ë§Œ, í•œ ì‹œëŒ€ë¥¼ í’ë¯¸í•œ ì´ ì¥ë¥´ëŠ” ìµœê·¼ 10ë…„ê°„ í•œêµ­ ìŒì•… ì”¬ì—ì„œ ì£¼ëª©ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.
                    ê·¸ëŸ¬ë‚˜ ì¼€ì´íŒì˜ ìµœê³  ì¸ê¸° ê·¸ë£¹ ë‰´ì§„ìŠ¤ì˜ "Supernatural"ë¡œ ì¸í•´ 
                    ë‰´ì­ìŠ¤ìœ™ì´ ë§ˆì¹¨ë‚´ ë©”ì¸ìŠ¤íŠ¸ë¦¼ì—ì„œ ì£¼ëª©ë°›ê²Œ ë˜ì–´ ì •ë§ ê¸°ì©ë‹ˆë‹¤. 
                    ì´ë¥¼ ê¸°ë…í•˜ê¸° ìœ„í•´ Murakami Takashië¥¼ ì˜¤ë§ˆì£¼í•œ ì•„íŠ¸ì›Œí¬ì™€ í•¨ê»˜ ë§¤ë…„ ì—¬ë¦„ë§ˆë‹¤ ì„ ë³´ì´ëŠ” ë¯¹ì…‹ì„ ì—…ë¡œë“œí•©ë‹ˆë‹¤.
                    ì˜¤ë˜ ê¸°ë‹¤ë¦¬ì…¨ìŠµë‹ˆë‹¤. ì¦ê²ê²Œ ë“¤ì–´ ì£¼ì‹œê³  ì‹œì›í•œ ì—¬ë¦„ ë˜ì„¸ìš”! â˜€ï¸ğŸ˜</div> -->
            </div>
            <div class="fixed-floating">
                <div class="floating-song">
                    <div><button class="btn__float__arrow__left" aria-label="ë’¤ë¡œê°€ê¸°" id="historyBack"></button></div>
                    <div><button class="btn__float__share--black" aria-label="í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ê³µìœ í•˜ê¸°" onclick="copyToClipBoard()"></button></div>
                </div>
            </div>
            <!-- í† ìŠ¤íŠ¸ë©”ì„¸ì§€ -->
            <div class="toast" id="toastMsg">
                <div class="toast__msg">
                    <div><button class="btn__checked"></button></div>
                    <span class="fs12">ë§í¬ê°€ ë³µì‚¬ ë˜ì—ˆìŠµë‹ˆë‹¤.</span>
                </div>
            </div>
        </div>
    </main>
    <script>
        let vidId; // 1. í•¨ìˆ˜ ì™¸ë¶€ì—ì„œ vidId ë³€ìˆ˜ ì„ ì–¸

        let apiReady = false; // 2. YouTube APIê°€ ì¤€ë¹„ë˜ì—ˆëŠ”ì§€ ì—¬ë¶€ë¥¼ ì¶”ì í•˜ëŠ” í”Œë˜ê·¸ ì„¤ì •

        window.onload = function() {
            fetchSongDetailList();
        };

        // URLì—ì„œ plyy id & song num ê°€ì ¸ì˜¤ê¸°
        let songPathList = window.location.pathname.split('/');
        let songUrlInfo = songPathList[songPathList.length - 1].split('+');
        const plyyId = songUrlInfo[0]; // str
        const songNum = songUrlInfo[1]; // str

        // ì „ì²´ ê³¡ëª©ë¡ fetch API
        function fetchSongDetailList(){
            fetch(`/api_song_detail/${plyyId}`)
            .then(response => response.json())
            .then(data => {
                // ì´ì „ê³¡ or ë‹¤ìŒê³¡ ë²„íŠ¼ í´ë¦­ì‹œ
                let intSongNum = Number(songNum);
                let maxIndexNum = Number(data.length - 1); // 7
                
                const nextSong = document.getElementById('nextSong');
                nextSong.addEventListener('click', () => {
                    if(intSongNum === maxIndexNum){ // í˜„ì¬ num == ë§ˆì§€ë§‰ ê³¡
                        let nextNum = 0;              
                        let nextPath = `/song_detail/${plyyId}+${nextNum}`;
                        window.location.href = nextPath;
                    }else if(intSongNum !== maxIndexNum){ // í˜„ì¬ num !== ë§ˆì§€ë§‰ ê³¡
                        let nextNum = intSongNum + 1;
                        let nextPath = `/song_detail/${plyyId}+${nextNum}`;
                        window.location.href = nextPath;
                    }
                });

                const preSong = document.getElementById('preSong');
                preSong.addEventListener('click', () => {
                    if(intSongNum === 0){
                        let preNum = maxIndexNum;
                        let prePath = `/song_detail/${plyyId}+${preNum}`;
                        window.location.href = prePath;
                    }else if(intSongNum !== 0){
                        let preNum = intSongNum - 1;
                        let prePath = `/song_detail/${plyyId}+${preNum}`;
                        window.location.href = prePath;
                    }
                });
                
                // ì¸ë±ì‹± : ë§ˆì§€ë§‰
                let totalSongs = data.length;
                const lastSongIndex = document.getElementById('lastSongIndex');
                lastSongIndex.innerText = totalSongs;

                // songNumì— ë§ëŠ” ê³¡ ì •ë³´ ì°¾ê¸°
                data.forEach(data => {
                    if(data.song.num == songNum){
                        // ì¸ë±ì‹± : í˜„ì¬ í˜ì´ì§€
                        const currentSongIndex = document.getElementById('currentSongIndex');
                        currentSongIndex.innerText = data.song.num + 1;

                        // ê³¡ì •ë³´ ê·¸ë¦¬ê¸°
                        const songInfo = document.getElementById('songInfo');
                        songInfo.innerHTML = `
                            <div class="song__img"><img src="${data.song.img}"></div>
                            <div class="song__info">
                                <p class="h1">${data.song.title}</p>
                                <p class="fs16">${data.song.artist}</p>
                                <p class="fs16">${data.song.album}</p>
                            </div>
                        `;
                        // ì½”ë©˜íŠ¸(ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ) ê·¸ë¦¬ê¸°
                        if(data.song.cmt){
                            const songCmt = document.getElementById('songCmt');
                            songCmt.classList.remove('hide');
                            songCmt.innerHTML = `<div class="pretendard">${data.song.cmt}</div>`;
                        };

                        // Youtube vidId ì¶”ì¶œí•˜ê¸°
                        let vidUrl = data.song.vid;
                        let vidUrlList = vidUrl.split('=');
                        vidId = vidUrlList[vidUrlList.length - 1]; // 3. ë¹„ë™ê¸° í•¨ìˆ˜ ì•ˆì—ì„œ vidId ë³€ìˆ˜ì˜ ê°’ì´ í• ë‹¹ë¨

                        // YouTube IFrame APIê°€ ë¡œë“œëœ í›„ ì´ˆê¸°í™”
                        // 6. vidIdë¥¼ ì„¤ì •í•œ í›„ apiReadyê°€ trueì¸ ê²½ìš° initializeYouTubePlayerë¥¼ í˜¸ì¶œ
                        if (apiReady) {
                            initializeYouTubePlayer();
                        }        
                    };
                });                
            })
        }

        // 4. YouTube IFrame API ë¡œë“œ
        function loadYouTubeIframeAPI() {
            // This code loads the IFrame Player API code asynchronously.
            var tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            var firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);   
        }

        // 5. YouTube IFrame API ì¤€ë¹„ ì™„ë£Œ ì½œë°±
        function onYouTubeIframeAPIReady() {
            apiReady = true; // APIê°€ ë¡œë“œë˜ë©´ apiReadyë¥¼ trueë¡œ ì„¤ì •í•˜ê³ ,

            if (vidId) { // vidIdê°€ ì´ë¯¸ ì„¤ì • ë˜ì—ˆë‹¤ë©´
                initializeYouTubePlayer(); // initializeYouTubePlayerë¥¼ í˜¸ì¶œí•˜ì—¬ í”Œë ˆì´ì–´ë¥¼ ì´ˆê¸°í™”
            }
        }

        // YouTube í”Œë ˆì´ì–´ ì´ˆê¸°í™”. 7. í˜¸ì¶œë¨
        function initializeYouTubePlayer() {
            player = new YT.Player('player', {
                videoId: vidId,
                events: {
                    'onReady': onPlayerReady
                }
            });
        }

        function onPlayerReady(event) {
            event.target.playVideo();
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ YouTube IFrame API ë¡œë“œ
        loadYouTubeIframeAPI();

        // í”Œë¡œíŒ… : ê³µìœ ë²„íŠ¼ í´ë¦­ì‹œ í´ë¦½ë³´ë“œ ë³µì‚¬ --> í† ìŠ¤íŠ¸ ë©”ì„¸ì§€
        function copyToClipBoard(){
            let songDetailUrl = window.location.href;

            let dummyInput = document.createElement('input');
            document.body.appendChild(dummyInput);
            dummyInput.value = songDetailUrl;
            dummyInput.select();
            document.execCommand('copy');
            document.body.removeChild(dummyInput);

            const toastMsg = document.getElementById('toastMsg');
            toastMsg.classList.add('active');
            setTimeout(() => {
                toastMsg.classList.remove('active');
            }, 1500);
        }

        function nextSong(p_id, next_num){
            let nextPath = `/song_detail/${p_id}+${next_num}`;
            window.location.href = nextPath;
        }

        // global.js íŒŒì¼ ì™œ ì•ˆë¨¹ì§€ ?
        document.getElementById('historyBack').addEventListener('click', () => {
            window.history.back();
        })
    </script>
    <script src="../static/js/global.js"></script>
</body>
</html>