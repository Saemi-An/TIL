<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLYY</title>
    <link rel="stylesheet" href="../static/css/style.css">
    <style>
        /* ì¶”í›„ì— JSë¡œ song íŒŒì¼ì— ë„£ì„ ìˆ˜ ìˆì„ê¹Œ? */
        .main__container {
            background-image: url('../static/images/song-detail-background.jpg');
            background-repeat: no-repeat;
            background-size: cover;
        }
    </style>
</head>
<body>
    <main class="main">
        <div class="main__container">
            <!-- ìœ íˆ¬ë¸Œ ë¹„ë””ì˜¤ -->
            <div class="song__youtube">
                <div id="youtube__area">
                    <div id="player"></div>
                </div>
            </div>
            <!-- ê³¡ ì¸ë±ìŠ¤  -->
            <div class="song__index align both">
                <div class="index badge tag">
                    <span>1</span>
                    <span>&nbsp;/&nbsp;</span>
                    <span>3</span>
                </div>
                <button class="btn__arrow-left--white"></button>
                <button class="btn__arrow-right"></button>
            </div>
            <!-- ê³¡ ìƒì„¸ -->
            <div class="song" id="songInfo">
                <!-- <div class="song__img"><img src="images/@album_img2.svg"></div>
                <div class="song__info">
                    <p class="h1">Attention</p>
                    <p class="fs16">ë‰´ì§„ìŠ¤</p>
                    <p class="fs16">NewJeans 1st EP 'New Jeans'</p>
                </div> -->
            </div>
            <!-- ê³¡ì—ëŒ€í•œ íë ˆì´í„° ì½”ë©˜íŠ¸ -->
            <div class="song-cmt hide" id="songCmt">
                <!-- <div class="pretendard">ë‰´ì­ìŠ¤ìœ™ì„ ì‹œë„í•˜ëŠ” ê·¸ë£¹ì´ë‚˜ ì•„í‹°ìŠ¤íŠ¸ëŠ” ë§ì•˜ì§€ë§Œ, í•œ ì‹œëŒ€ë¥¼ í’ë¯¸í•œ ì´ ì¥ë¥´ëŠ” ìµœê·¼ 10ë…„ê°„ í•œêµ­ ìŒì•… ì”¬ì—ì„œ ì£¼ëª©ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.
                    ê·¸ëŸ¬ë‚˜ ì¼€ì´íŒì˜ ìµœê³  ì¸ê¸° ê·¸ë£¹ ë‰´ì§„ìŠ¤ì˜ "Supernatural"ë¡œ ì¸í•´ 
                    ë‰´ì­ìŠ¤ìœ™ì´ ë§ˆì¹¨ë‚´ ë©”ì¸ìŠ¤íŠ¸ë¦¼ì—ì„œ ì£¼ëª©ë°›ê²Œ ë˜ì–´ ì •ë§ ê¸°ì©ë‹ˆë‹¤. 
                    ì´ë¥¼ ê¸°ë…í•˜ê¸° ìœ„í•´ Murakami Takashië¥¼ ì˜¤ë§ˆì£¼í•œ ì•„íŠ¸ì›Œí¬ì™€ í•¨ê»˜ ë§¤ë…„ ì—¬ë¦„ë§ˆë‹¤ ì„ ë³´ì´ëŠ” ë¯¹ì…‹ì„ ì—…ë¡œë“œí•©ë‹ˆë‹¤.
                    ì˜¤ë˜ ê¸°ë‹¤ë¦¬ì…¨ìŠµë‹ˆë‹¤. ì¦ê²ê²Œ ë“¤ì–´ ì£¼ì‹œê³  ì‹œì›í•œ ì—¬ë¦„ ë˜ì„¸ìš”! â˜€ï¸ğŸ˜</div> -->
            </div>
            <div class="fixed-floating">
                <div class="floating-song">
                    <div><button class="btn__float__arrow__left" aria-label="ë’¤ë¡œê°€ê¸°"></button></div>
                    <div><button class="btn__float__share--black" aria-label="í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ê³µìœ í•˜ê¸°"></button></div>
                </div>
            </div>
        </div>
    </main>
    <script>
        let vidId; // 1. fetch í•¨ìˆ˜ ë°–ì—ì„œ vidId ë³€ìˆ˜ ì„ ì–¸

        let apiReady = false; // YouTube APIê°€ ì¤€ë¹„ë˜ì—ˆëŠ”ì§€ ì—¬ë¶€ë¥¼ ì¶”ì í•˜ëŠ” í”Œë˜ê·¸

        window.onload = function() {
            fetchSongDetailList();
        };

        // URLì—ì„œ plyy id & song num ê°€ì ¸ì˜¤ê¸°
        let songPathList = window.location.pathname.split('/');
        let songUrlInfo = songPathList[songPathList.length - 1].split('+');
        const plyyId = songUrlInfo[0];
        const songNum = songUrlInfo[1];

        // ê³¡ìƒì„¸ - ì „ì²´ ê³¡ëª©ë¡ fetch API
        function fetchSongDetailList(){
            fetch(`/api_song_detail/${plyyId}`)
            .then(response => response.json())
            .then(data => {
                data.forEach(data => {
                    // songNumì— ë§ëŠ” ê³¡ ì°¾ê¸°
                    if(data.song.num == songNum){
                        // ê³¡ ìƒì„¸ - ê³¡ì •ë³´
                        const songInfo = document.getElementById('songInfo');
                        songInfo.innerHTML = `
                            <div class="song__img"><img src="${data.song.img}"></div>
                            <div class="song__info">
                                <p class="h1">${data.song.title}</p>
                                <p class="fs16">${data.song.artist}</p>
                                <p class="fs16">${data.song.album}</p>
                            </div>
                        `;
                        // ê³¡ìƒì„¸ - ì½”ë©˜íŠ¸ (ì½”ë©˜íŠ¸ ì¡´ì¬í•  ì‹œì—ë§Œ ë¡œë”©)
                        if(data.song.cmt){
                            const songCmt = document.getElementById('songCmt');
                            songCmt.classList.remove('hide');
                            songCmt.innerHTML = `<div class="pretendard">${data.song.cmt}</div>`;
                        }else{};

                        // Youtube vidId
                        let vidUrl = data.song.vid;
                        let vidUrlList = vidUrl.split('=');
                        
                        // 2. fetch í•¨ìˆ˜ ì•ˆì—ì„œ vidId ë³€ìˆ˜ê°€ ê°’ì„ í• ë‹¹ë°›ìŒ
                        vidId = vidUrlList[vidUrlList.length - 1];
                        // vidID = 'HGpyXfCqBCk';  

                        // YouTube IFrame APIê°€ ë¡œë“œëœ í›„ ì´ˆê¸°í™”
                        if (apiReady) {
                            initializeYouTubePlayer();
                        }        
                    };
                });                
            })
        }

        // YouTube IFrame API ë¡œë“œ
        function loadYouTubeIframeAPI() {
            // 2. This code loads the IFrame Player API code asynchronously.
            var tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            var firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);   
        }

        // YouTube IFrame API ì¤€ë¹„ ì™„ë£Œ ì½œë°±
        function onYouTubeIframeAPIReady() {
            apiReady = true; // APIê°€ ì¤€ë¹„ë˜ì—ˆìŒì„ ê¸°ë¡
            if (vidId) {
                initializeYouTubePlayer(); // vidIdê°€ ì„¤ì •ëœ í›„ í”Œë ˆì´ì–´ ì´ˆê¸°í™”
            }
        }

        // YouTube í”Œë ˆì´ì–´ ì´ˆê¸°í™”
        function initializeYouTubePlayer() {
            player = new YT.Player('player', {
                videoId: vidId,
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerReady(event) {
            event.target.playVideo();
        }

        var done = false;
        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING && !done) {
                done = true;
            }
        }

        function stopVideo() {
            player.stopVideo();
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ YouTube IFrame API ë¡œë“œ
        loadYouTubeIframeAPI();


        function demo() {
            // YOUTUBE
            // 2. This code loads the IFrame Player API code asynchronously.
            var tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            var firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);  
    
            // 3. This function creates an <iframe> (and YouTube player)
            //    after the API code downloads.
            var player;
            function onYouTubeIframeAPIReady() {
                player = new YT.Player('player', {
                    videoId: `${vidId}`,
                    // videoId: 'HGpyXfCqBCk',
                    events: {
                        'onReady': onPlayerReady,
                        'onStateChange': onPlayerStateChange
                    }
                });
            }
            
            // 4. The API will call this function when the video player is ready.
            function onPlayerReady(event) {
            event.target.playVideo();
            }
    
            // 5. The API calls this function when the player's state changes.
            //    The function indicates that when playing a video (state=1),
            //    the player should play for six seconds and then stop.
            var done = false;
            function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING && !done) {
            //   setTimeout(stopVideo, 6000);
                done = true;
            }
            }
            function stopVideo() {
            player.stopVideo();
            }
        }

    </script>
</body>
</html>